<div class="header">
  <h1>Community Engagement Requirement Report</h1>
  <p>Form ID: <%= @engagement_form.id %></p>
  <p>Submitted: <%= @engagement_form.created_at.strftime("%B %d, %Y at %I:%M %p") %></p>
</div>

<% verifier = EngagementRequirementsVerifier.new(@engagement_form) %>
<% details = verifier.verification_details %>

<% if verifier.meets_requirements? %>
  <div class="usa-alert usa-alert--success" style="margin: 20px 0; padding: 15px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px;">
    <div class="usa-alert__body">
      <h3 class="usa-alert__heading" style="margin: 0 0 10px 0; color: #155724; font-size: 18px;">Requirements Met</h3>
      <div class="usa-alert__text" style="color: #155724;">
        <% if details[:enrolled_half_time_or_more] %>
          <p style="margin: 5px 0;"><strong>Qualification:</strong> Enrolled at least half-time in school</p>
        <% elsif details[:income_requirement_met] %>
          <p style="margin: 5px 0;"><strong>Qualification:</strong> Gross monthly income of $<%= number_with_precision(details[:total_income], precision: 2) %> (meets minimum of $580)</p>
        <% elsif details[:hours_requirement_met] %>
          <p style="margin: 5px 0;"><strong>Qualification:</strong> Total of <%= details[:total_hours] %> hours (meets minimum of 80 hours)</p>
          <p style="margin: 5px 0; font-size: 14px;">
            Breakdown: 
            <% breakdown_parts = [] %>
            <% breakdown_parts << "#{details[:work_hours]} work hours" if details[:work_hours] > 0 %>
            <% breakdown_parts << "#{details[:school_hours]} school hours" if details[:school_hours] > 0 %>
            <% breakdown_parts << "#{details[:work_program_hours]} work program hours" if details[:work_program_hours] > 0 %>
            <% breakdown_parts << "#{details[:volunteer_hours]} volunteer hours" if details[:volunteer_hours] > 0 %>
            <%= breakdown_parts.join(", ") %>
          </p>
        <% end %>
      </div>
    </div>
  </div>
<% else %>
  <div class="usa-alert usa-alert--warning" style="margin: 20px 0; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
    <div class="usa-alert__body">
      <h3 class="usa-alert__heading" style="margin: 0 0 10px 0; color: #856404; font-size: 18px;">Requirements Not Met</h3>
      <div class="usa-alert__text" style="color: #856404;">
        <p style="margin: 5px 0;">Based on the information provided, the user does not meet Community Engagement Requirements.</p>
        
        <p style="margin: 10px 0; font-weight: bold;">Explanation:</p>
        <ul style="margin: 10px 0; padding-left: 20px;">
          <% if @engagement_form.is_student? && @engagement_form.enrollment_status == "less_than_half_time" %>
            <li style="margin: 5px 0;">Enrolled less than half-time in school</li>
          <% elsif @engagement_form.is_student? && @engagement_form.enrollment_status == "half_time_or_more" %>
            <li style="margin: 5px 0;">Enrolled half-time or more (should qualify - please check data)</li>
          <% else %>
            <li style="margin: 5px 0;">Not enrolled in school</li>
          <% end %>
          
          <% if @engagement_form.has_job? %>
            <li style="margin: 5px 0;">Gross monthly income: $<%= number_with_precision(details[:total_income], precision: 2) %> (minimum required: $580)</li>
          <% else %>
            <li style="margin: 5px 0;">No employment income reported</li>
          <% end %>
          
          <li style="margin: 5px 0;">Total hours: <%= details[:total_hours] %> (minimum required: 80)</li>
          <% if details[:total_hours] > 0 %>
            <li style="margin: 5px 0; font-size: 14px; margin-left: 20px;">
              Breakdown: 
              <% breakdown_parts = [] %>
              <% breakdown_parts << "#{details[:work_hours]} work hours" if details[:work_hours] > 0 %>
              <% breakdown_parts << "#{details[:school_hours]} school hours" if details[:school_hours] > 0 %>
              <% breakdown_parts << "#{details[:work_program_hours]} work program hours" if details[:work_program_hours] > 0 %>
              <% breakdown_parts << "#{details[:volunteer_hours]} volunteer hours" if details[:volunteer_hours] > 0 %>
              <%= breakdown_parts.join(", ") %>
            </li>
          <% end %>
        </ul>
      </div>
    </div>
  </div>
<% end %>

<% if details[:unused_data].any? %>
  <div class="usa-alert usa-alert--info" style="margin: 20px 0; padding: 15px; background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px;">
    <div class="usa-alert__body">
      <h3 class="usa-alert__heading" style="margin: 0 0 10px 0; color: #0c5460; font-size: 16px;">Data Not Used for Verification</h3>
      <div class="usa-alert__text" style="color: #0c5460; font-size: 14px;">
        <p style="margin: 5px 0;">The following data was not used for verification because it falls outside the prior month (<%= @engagement_form.prior_month_name %>):</p>
        
        <% if details[:unused_data][:job_paychecks] %>
          <div style="margin: 10px 0;">
            <strong>Job Paychecks:</strong>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><%= details[:unused_data][:job_paychecks][:count] %> paycheck(s) from <%= details[:unused_data][:job_paychecks][:months].join(", ") %></li>
              <li>Total income: $<%= number_with_precision(details[:unused_data][:job_paychecks][:total_income], precision: 2) %></li>
              <li>Total hours: <%= details[:unused_data][:job_paychecks][:total_hours] %></li>
            </ul>
          </div>
        <% end %>
        
        <% if details[:unused_data][:volunteer_shifts] %>
          <div style="margin: 10px 0;">
            <strong>Volunteer Shifts:</strong>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><%= details[:unused_data][:volunteer_shifts][:count] %> shift(s) from <%= details[:unused_data][:volunteer_shifts][:months].join(", ") %></li>
              <li>Total hours: <%= details[:unused_data][:volunteer_shifts][:total_hours] %></li>
            </ul>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<div class="section">
  <h2>Basic Information</h2>
  
  <div class="field">
    <span class="field-label">Full Name:</span>
    <div class="field-value"><%= @engagement_form.user_name %></div>
  </div>
  
  <div class="field">
    <span class="field-label">Email Address:</span>
    <div class="field-value"><%= @engagement_form.email %></div>
  </div>
  
  
</div>

<div class="section">
  <h2>Community Engagement Activities</h2>
  
  <div class="field">
    <span class="field-label">Engagement Types:</span>
    <div class="field-value">
      <% engagement_types = [] %>
      <% engagement_types << "Has a job" if @engagement_form.has_job? %>
      <% engagement_types << "Is a student" if @engagement_form.is_student? %>
      <% engagement_types << "Enrolled in work program" if @engagement_form.enrolled_work_program? %>
      <% engagement_types << "Volunteers with nonprofit" if @engagement_form.volunteers_nonprofit? %>
      <%= engagement_types.join(", ") %>
    </div>
  </div>
  
  <% if @engagement_form.has_job? && @engagement_form.job_paychecks.any? %>
    <div class="field">
      <span class="field-label">Employment Details:</span>
      <div class="field-value">
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
          <thead>
            <tr style="background-color: #f0f0f0;">
              <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Pay Date</th>
              <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Gross Pay</th>
              <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Hours</th>
            </tr>
          </thead>
          <tbody>
            <% @engagement_form.job_paychecks.ordered_by_date.each do |paycheck| %>
              <tr>
                <td style="border: 1px solid #ccc; padding: 8px;"><%= paycheck.pay_date.strftime("%B %d, %Y") %></td>
                <td style="border: 1px solid #ccc; padding: 8px;">$<%= number_with_precision(paycheck.gross_pay_amount, precision: 2) %></td>
                <td style="border: 1px solid #ccc; padding: 8px;"><%= paycheck.hours_worked %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
        <p style="margin-top: 10px; font-weight: bold;">Total Hours: <%= @engagement_form.job_paychecks.sum(&:hours_worked) %></p>
        <p style="margin-top: 5px; font-weight: bold;">Total Gross Pay: $<%= number_with_precision(@engagement_form.job_paychecks.sum(&:gross_pay_amount), precision: 2) %></p>
      </div>
    </div>
  <% elsif @engagement_form.has_job? %>
    <div class="field">
      <span class="field-label">Employment Details:</span>
      <div class="field-value">No paychecks have been added yet.</div>
    </div>
  <% end %>
  
  <% if @engagement_form.is_student? %>
    <div class="field">
      <span class="field-label">Student Details:</span>
      <div class="field-value">
        <% if @engagement_form.school_name.present? %>
          <p><strong>School:</strong> <%= @engagement_form.school_name %></p>
        <% end %>
        <% if @engagement_form.enrollment_status == "half_time_or_more" %>
          <p><strong>Enrollment Status:</strong> Enrolled at least half-time</p>
        <% elsif @engagement_form.enrollment_status == "less_than_half_time" %>
          <p><strong>Enrollment Status:</strong> Enrolled less than half-time</p>
          <% if @engagement_form.school_hours.present? %>
            <p><strong>School Hours per Week:</strong> <%= @engagement_form.school_hours %> hours</p>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>
  
  <% if @engagement_form.enrolled_work_program? %>
    <div class="field">
      <span class="field-label">Work Program Details:</span>
      <div class="field-value">
        <% if @engagement_form.work_program_name.present? %>
          <p><strong>Work Program Name:</strong> <%= @engagement_form.work_program_name %></p>
        <% end %>
        <% if @engagement_form.hours_attended.present? %>
          <p><strong>Hours Attended:</strong> <%= @engagement_form.hours_attended %> hours</p>
        <% end %>
      </div>
    </div>
  <% end %>
  
  <% if @engagement_form.volunteers_nonprofit? && @engagement_form.volunteer_shifts.any? %>
    <div class="field">
      <span class="field-label">Volunteer Hours:</span>
      <div class="field-value">
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
          <thead>
            <tr style="background-color: #f0f0f0;">
              <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Organization</th>
              <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Date</th>
              <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Hours</th>
            </tr>
          </thead>
          <tbody>
            <% @engagement_form.volunteer_shifts.ordered_by_date.each do |shift| %>
              <tr>
                <td style="border: 1px solid #ccc; padding: 8px;"><%= shift.organization_name %></td>
                <td style="border: 1px solid #ccc; padding: 8px;"><%= shift.shift_date.strftime("%B %d, %Y") %></td>
                <td style="border: 1px solid #ccc; padding: 8px;"><%= shift.hours %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
        <p style="margin-top: 10px; font-weight: bold;">Total Volunteer Hours: <%= @engagement_form.volunteer_shifts.sum(&:hours) %></p>
      </div>
    </div>
  <% elsif @engagement_form.volunteers_nonprofit? %>
    <div class="field">
      <span class="field-label">Volunteer Hours:</span>
      <div class="field-value">No volunteer shifts have been added yet.</div>
    </div>
  <% end %>
</div>
